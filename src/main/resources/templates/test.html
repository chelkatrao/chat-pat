<script src="/webjars/vue/2.6.11/vue.min.js"></script>
<script src="/webjars/jquery/3.0.0/jquery.min.js"></script>
<script src="/webjars/popper.js/2.5.2/umd/popper.min.js"></script>
<script src="/webjars/axios/0.19.0/dist/axios.min.js"></script>

<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
<script src="/webjars/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<html>
<head>
    <link rel="stylesheet" type="text/css" href="/style.css"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"
          href="../../css/main.css"/>

</head>
<body class="body">

<div class="container" id="app">
    <div class="large-12 medium-12 small-12 cell">
        <label>Files
            <input type="file" id="files" ref="files" accept="image/*" multiple v-on:change="handleFilesUpload()"/>
        </label>
    </div>
    <div class="large-12 medium-12 small-12 cell">
        <button id="show-modal" @click="showModal = true">Show Modal</button>
        <!-- use the modal component, pass in the prop -->
        <modal v-if="showModal">
            <div slot="x" class="modal-footer">
                <button class="modal-default-button" v-on:click="closeModal()">
                    âœ•
                </button>
            </div>
            <h3 slot="header">Upload profile photo</h3>
            <div class="grid-x" slot="body">
                <div v-for="(file, key) in files" class="large-4 medium-4 small-6 cell file-listing">
                    <img class="preview" v-bind:ref="'image'+parseInt( key )"/>
                </div>
            </div>
            <div slot="footer">
                <button class="btn btn-success" @click="$emit('close')">
                    Submit
                </button>
            </div>
        </modal>

    </div>
    <br>
    <div class="large-12 medium-12 small-12 cell clear">
        <button v-on:click="addFiles()">Add Files</button>
    </div>
    <br>

</div>
<script>
    // register modal component
    Vue.component("modal", {
        template: "#modal-template"
    });

    let photoUpload = new Vue({
        el: '#app',

        data() {
            return {
                files: [],
                showModal: false
            }
        },

        methods: {
            addFiles() {
                this.$refs.files.click();
            },
            closeModal() {
                this.files = [];
                this.showModal = false;
            },
            submitFiles() {
                let formData = new FormData();
                for (var i = 0; i < this.files.length; i++) {
                    let file = this.files[i];

                    formData.append('files[' + i + ']', file);
                }
                axios.post('/file-multiple-preview',
                    formData,
                    {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    }
                ).then(function () {
                    console.log('SUCCESS!!');
                })
                    .catch(function () {
                        console.log('FAILURE!!');
                    });
            },

            handleFilesUpload() {
                this.showModal = true;
                debugger;
                let uploadedFiles = this.$refs.files.files;

                for (var i = 0; i < uploadedFiles.length; i++) {
                    this.files.push(uploadedFiles[i]);
                }
                this.getImagePreviews();
            },


            getImagePreviews() {
                for (let i = 0; i < this.files.length; i++) {
                    if (/\.(jpe?g|png|gif)$/i.test(this.files[i].name)) {
                        let reader = new FileReader();
                        reader.addEventListener("load", function () {
                            this.$refs['image' + parseInt(i)][0].src = reader.result;
                        }.bind(this), false);
                        reader.readAsDataURL(this.files[i]);
                    }
                }
            }
        },
    });
</script>
</body>
</html>

